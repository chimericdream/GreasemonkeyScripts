// ==UserScript==
// @name        Comic Rocket Science
// @description Greasemonkey script to add more comic management features to Comic Rocket.
// @version     0.2.0a
// @updateUrl   https://github.com/chimericdream/GreasemonkeyScripts/raw/master/dist/comic-rocket-science/comic-rocket-science.meta.js
// @downloadUrl https://github.com/chimericdream/GreasemonkeyScripts/raw/master/dist/comic-rocket-science/comic-rocket-science.user.js
// @include     http://comic-rocket.com/
// @include     http://www.comic-rocket.com/
// @include     https://comic-rocket.com/
// @include     https://www.comic-rocket.com/
// @grant       none
// ==/UserScript==
!function(t,e,a,r){"use strict";function c(){d.empty();for(var t=0;t<s.length;t++)d.append(s[t]);i()}function n(){for(var t=0;t<s.length;t++){var e=s[t],a=e.attr("data-title").toLowerCase(),r=e.attr("data-rating"),c=""===g.title||a.includes(g.title),n=3===g.rating.length||-1!==g.rating.indexOf(r);c&&n?e.show():e.hide()}i()}function i(){for(var t=0,e=0;e<s.length;e++)s[e].is(":visible")&&t++;p.text("Showing "+t+" of "+s.length+" comics.")}var o={PG:1,R:2,"NC-17":3},s=[],l=null,d=t(a.createElement("div")),p=t(a.createElement("div")).attr("id","comic-status-text"),m=0,b=0,g={title:"",rating:["PG","R","NC-17"]},u={title:function(t,e){var a=t.attr("data-title").toLowerCase(),r=e.attr("data-title").toLowerCase();return a=a.replace(/^((an?|the) )/,""),r=r.replace(/^((an?|the) )/,""),a===r?0:a>r?1:-1},rating:function(t,e){var a=o[t.attr("data-rating")],r=o[e.attr("data-rating")];return parseInt(a)-parseInt(r)},read:function(t,e){var a=t.attr("data-read"),r=e.attr("data-read");return parseInt(a)-parseInt(r)},total:function(t,e){var a=t.attr("data-total"),r=e.attr("data-total");return parseInt(a)-parseInt(r)},updated:function(t,e){var a=t.attr("data-date"),r=e.attr("data-date");return parseInt(a)-parseInt(r)}};t(a).ready(function(){var e=["#comic-rocket-science-controls {background-color: #51493d; color: #FFF; margin: 0 auto 20px; width: 552px; padding: 10px;}","#comic-rocket-science-controls .comics-item-image span {height: auto; padding: 0 0 1ex 0;}","#comic-rocket-science-controls .form-search input {border-radius: 3px; padding-left: 10px; width: calc(100% - 14px);}","#comic-rocket-science-controls label {color: #FFF; display: inline-block;}","#comic-rocket-science-controls label + label {margin-left: 5px;}","#comic-rocket-science-controls label input {display: inline;}","#comic-rocket-science-controls .btn-primary {padding: 5px 10px; background-image: none;}","#comic-rocket-science-controls .btn-primary span {display: none;}","#comic-rocket-science-controls .btn-primary.sorted-asc {font-weight: bold;}","#comic-rocket-science-controls .btn-primary.sorted-desc {font-weight: bold;}","#comic-rocket-science-controls .btn-primary.sorted-asc .asc {display: inline;}","#comic-rocket-science-controls .btn-primary.sorted-desc .desc {display: inline;}","#comic-rocket-science-controls .btn-primary + .btn-primary {margin-left: 5px;}","#comic-status-text {margin: 0 auto 10px; width: 572px;}"],r="<style>"+e.join("")+"</style>";t("head").append(r),t(".comics-item").each(function(){var e=t(this),a=e.find(".comics-item-image span").text(),r=e.find(".comics-item-rating abbr").text(),c=e.find(".comics-item-date div").text().replace("Updated: ","").replace("-",""),n=e.find(".progress-label").text().split("/");m+=parseInt(n[0]),b+=parseInt(n[1]),e.attr("data-title",a),e.attr("data-rating",r),e.attr("data-date",c),e.attr("data-read",n[0]),e.attr("data-total",n[1]),null===l&&(l=e.parent()),s.push(e)}),l.attr("id","comics-wrapper");var n=t("#comic-rocket-sidebar").parent().children()[0],i=t(n).children()[0],o=m/b*100;t(i).append("<p>Overall progress: "+m+"/"+b+" ("+o.toFixed(2)+"%)</p>");var g=t(a.createElement("div"));g.attr("id","comic-rocket-science-controls");var h='<span class="comics-item-image"><span>Comic Rocket <strong>Science</strong></span></span>',f='<div class="form-search"><input id="crs-title-search" placeholder="Filter by title"/></div>',v=['<label><input type="checkbox" name="crs-rating-filter" value="PG" checked> PG</label>','<label><input type="checkbox" name="crs-rating-filter" value="R" checked> R</label>','<label><input type="checkbox" name="crs-rating-filter" value="NC-17" checked> NC-17</label>'],k='<span class="asc"> &uparrow;</span><span class="desc"> &downarrow;</span>',y=['<a class="btn btn-primary sort-btn sorted-asc" id="crs-sort-title" href="#">Title'+k+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-rating" href="#">Rating'+k+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-read" href="#">Read'+k+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-total" href="#">Total'+k+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-updated" href="#">Updated'+k+"</a>"],x=[h,f,"<strong>Filter by rating:</strong>",v.join(""),"<strong>Sort by:</strong>",y.join("")];l.empty().prepend(g).append(d),g.append(x.join("<br>")),g.after("<hr>"),d.before(p),s.sort(u.title),c()}),t(".span8").on("keyup","#crs-title-search",function(e){e.preventDefault(),e.stopPropagation(),g.title=t(this).val().toLowerCase(),n()}),t(".span8").on("click","#comic-rocket-science-controls .sort-btn",function(e){e.preventDefault(),e.stopPropagation();var a=t(this),r=1;a.hasClass("sorted-asc")?r=-1:a.hasClass("sorted-desc")&&(r=1),t("#comic-rocket-science-controls .sort-btn").removeClass("sorted-asc").removeClass("sorted-desc");var n=a.attr("id").replace("crs-sort-","");s.sort(u[n]),0>r?(s.reverse(),a.addClass("sorted-desc")):a.addClass("sorted-asc"),c()}),t(".span8").on("click","#comic-rocket-science-controls input",function(e){e.stopPropagation();var a=t(this);if(a.attr("checked"))g.rating.push(a.val());else{var r=g.rating.indexOf(a.val());g.rating.splice(r,1)}n()})}(window.jQuery,window,document);