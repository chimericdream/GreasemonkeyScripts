// ==UserScript==
// @name        Comic Rocket Science
// @description Greasemonkey script to add more comic management features to Comic Rocket.
// @version     0.3.3a
// @updateUrl   https://github.com/chimericdream/GreasemonkeyScripts/raw/master/dist/comic-rocket-science/comic-rocket-science.meta.js
// @downloadUrl https://github.com/chimericdream/GreasemonkeyScripts/raw/master/dist/comic-rocket-science/comic-rocket-science.user.js
// @include     http://comic-rocket.com/
// @include     http://www.comic-rocket.com/
// @include     https://comic-rocket.com/
// @include     https://www.comic-rocket.com/
// @grant       none
// ==/UserScript==
!function(t,e,r,a){"use strict";function i(){this.controls=new s,this.list=new c,this.sidebar=new n}function s(){this.$container=t(r.createElement("div")),this.$container.attr("id","comic-rocket-science-controls")}function n(){this.readStrips=0,this.totalStrips=0,this.$progress=t(r.createElement("p"));var e=t("#comic-rocket-sidebar").parent().children()[0],a=t(e).children()[0];t(a).append(this.$progress)}function c(){this.$wrapper=null,this.$container=t(r.createElement("div")),this.$comics=[],this.$status=t(r.createElement("div")).attr("id","comic-status-text"),this.comicFilter={title:"",rating:["PG","R","NC-17","UR"]}}var o=new i;t(r).ready(function(){var e=["#comic-rocket-science-controls {background-color: #51493d; color: #FFF; margin: 0 auto 20px; width: 552px; padding: 10px;}","#comic-rocket-science-controls .comics-item-image span {height: auto; padding: 0 0 1ex 0;}","#comic-rocket-science-controls .form-search input {border-radius: 3px; padding-left: 10px; width: calc(100% - 14px);}","#comic-rocket-science-controls label {color: #FFF; display: inline-block;}","#comic-rocket-science-controls label + label {margin-left: 5px;}","#comic-rocket-science-controls label input {display: inline;}","#comic-rocket-science-controls .btn-primary {padding: 5px 10px; background-image: none;}","#comic-rocket-science-controls .btn-primary span {display: none;}","#comic-rocket-science-controls .btn-primary.sorted-asc {font-weight: bold;}","#comic-rocket-science-controls .btn-primary.sorted-desc {font-weight: bold;}","#comic-rocket-science-controls .btn-primary.sorted-asc .asc {display: inline;}","#comic-rocket-science-controls .btn-primary.sorted-desc .desc {display: inline;}","#comic-rocket-science-controls .btn-primary + .btn-primary {margin-left: 5px;}","#comic-status-text {margin: 0 auto 10px; width: 572px;}"],r="<style>"+e.join("")+"</style>";t("head").append(r),o.initialize(),o.renderSidebar();var a='<span class="comics-item-image" title="v0.3.3a"><span>Comic Rocket <strong>Science</strong></span></span>',i='<div class="form-search"><input id="crs-title-search" placeholder="Filter by title"/></div>',s=['<label><input class="rating-filter" type="checkbox" name="crs-rating-filter" value="PG" checked> PG</label>','<label><input class="rating-filter" type="checkbox" name="crs-rating-filter" value="R" checked> R</label>','<label><input class="rating-filter" type="checkbox" name="crs-rating-filter" value="NC-17" checked> NC-17</label>','<label><input class="rating-filter" type="checkbox" name="crs-rating-filter" value="UR" checked> Unrated</label>'],n='<span class="asc"> &uparrow;</span><span class="desc"> &downarrow;</span>',c=['<a class="btn btn-primary sort-btn sorted-asc" id="crs-sort-title" href="#">Title'+n+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-rating" href="#">Rating'+n+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-unread" href="#"># Unread'+n+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-read" href="#"># Read'+n+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-percent-read" href="#">% Read'+n+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-total" href="#">Total'+n+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-updated" href="#">Updated'+n+"</a>"];[a,i,"<strong>Filter by rating:</strong>",s.join(""),"<strong>Sort by:</strong>",c.join("")]}),t(".span8").on("keyup","#crs-title-search",o.handleSearch),t(".span8").on("click","#comic-rocket-science-controls .sort-btn",o.handleSort),t(".span8").on("click","#comic-rocket-science-controls .rating-filter",function(e){e.stopPropagation();var r=t(this);if(r.attr("checked"))filter.rating.push(r.val());else{var a=filter.rating.indexOf(r.val());filter.rating.splice(a,1)}filterComics()}),i.prototype.initialize=function(){var e=[],r={read:0,total:0};t(".comics-item").each(function(){var a=t(this),i=a.find(".comics-item-image span").text(),s=a.find(".comics-item-rating abbr").text(),n=a.find(".comics-item-date div").text().replace("Updated: ","").replace("-",""),c=a.find(".progress-label").text().split("/");r.read+=parseInt(c[0]),r.total+=parseInt(c[1]),a.attr("data-title",i),""===s?a.attr("data-rating","UR"):a.attr("data-rating",s),a.attr("data-date",n),a.attr("data-read",r[0]),a.attr("data-total",r[1]),e.push(a)}),this.list.setComicList(e),this.sidebar.setProgress(r.read,r.total)},i.prototype.handleSort=function(e){e.preventDefault(),e.stopPropagation();var r=t(this),a=r.attr("id").replace("crs-sort-",""),i=p.ASC;r.hasClass("sorted-desc")&&(i=p.DESC),t("#comic-rocket-science-controls .sort-btn").removeClass("sorted-asc").removeClass("sorted-desc"),this.list.sort(a,-1*i),r.addClass("asc"),this.list.render()},i.prototype.handleSearch=function(e){e.preventDefault(),e.stopPropagation(),this.list.setTitleFilter(t(this).val())},i.prototype.renderSidebar=function(){this.sidebar.render()},n.prototype.setProgress=function(t,e){this.readStrips=t,this.totalStrips=e},n.prototype.render=function(){var t=this.readStrips/this.totalStrips*100;this.$progress.text("Overall progress: "+this.readStrips+"/"+this.totalStrips+" ("+t.toFixed(2)+"%)")},c.prototype.setComicList=function(t){this.$comics=t,t.length>0?(this.$wrapper=t[0].parent(),this.$wrapper.attr("id","comics-wrapper")):this.$wrapper=null},c.prototype.render=function(){this.$container.empty(),this.$container.append(this.$comics),this.updateStatusText()},c.prototype.sort=function(t,e){this.$comics.sort(d[t]),0>e&&this.$comics.reverse()},c.prototype.setTitleFilter=function(t){this.comicFilter.title=t.toLowerCase(),this.filter()},c.prototype.filter=function(){this.$comics.forEach(function(t){var e=t.attr("data-title").toLowerCase(),r=t.attr("data-rating"),a=""===this.comicFilter.title||e.includes(this.comicFilter.title),i=4===this.comicFilter.rating.length||-1!==this.comicFilter.rating.indexOf(r);return a&&i?void t.show():void t.hide()},this),this.updateStatusText()},c.prototype.updateStatusText=function(){var t=this.$comics.filter(function(t){return t.is(":visible")}).length;this.$status.text("Showing "+t+" of "+this.$comics.length+" comics.")};var l={PG:1,R:2,"NC-17":3,UR:4},p={ASC:1,DESC:-1},d={title:function(t,e){var r=t.attr("data-title").toLowerCase(),a=e.attr("data-title").toLowerCase();return r=r.replace(/^((an?|the) )/,""),a=a.replace(/^((an?|the) )/,""),r===a?0:r>a?1:-1},rating:function(t,e){var r=l[t.attr("data-rating")],a=l[e.attr("data-rating")];return parseInt(r)-parseInt(a)},read:function(t,e){var r=t.attr("data-read"),a=e.attr("data-read");return parseInt(r)-parseInt(a)},total:function(t,e){var r=t.attr("data-total"),a=e.attr("data-total");return parseInt(r)-parseInt(a)},updated:function(t,e){var r=t.attr("data-date"),a=e.attr("data-date");return parseInt(r)-parseInt(a)},unread:function(t,e){var r=parseInt(t.attr("data-total"))-parseInt(t.attr("data-read")),a=parseInt(e.attr("data-total"))-parseInt(e.attr("data-read"));return parseInt(r)-parseInt(a)},"percent-read":function(t,e){var r=parseInt(t.attr("data-read"))/parseInt(t.attr("data-total"))*100,a=parseInt(e.attr("data-read"))/parseInt(e.attr("data-total"))*100;return r-a}}}(window.jQuery,window,document);