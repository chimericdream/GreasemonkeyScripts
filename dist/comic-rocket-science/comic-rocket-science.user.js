// ==UserScript==
// @name        Comic Rocket Science
// @description Greasemonkey script to add more comic management features to Comic Rocket.
// @version     0.2.0a
// @updateUrl   https://github.com/chimericdream/GreasemonkeyScripts/raw/master/dist/comic-rocket-science/comic-rocket-science.meta.js
// @downloadUrl https://github.com/chimericdream/GreasemonkeyScripts/raw/master/dist/comic-rocket-science/comic-rocket-science.user.js
// @include     http://comic-rocket.com/
// @include     http://www.comic-rocket.com/
// @include     https://comic-rocket.com/
// @include     https://www.comic-rocket.com/
// @grant       none
// ==/UserScript==
!function(t,e,a,r){"use strict";function c(){u.empty();for(var t=0;t<b.length;t++)u.append(b[t]);p()}function n(t,e){var a=t.attr("data-title").toLowerCase(),r=e.attr("data-title").toLowerCase();return a=a.replace(/^((an?|the) )/,""),r=r.replace(/^((an?|the) )/,""),a===r?0:a>r?1:-1}function s(t,e){var a=m[t.attr("data-rating")],r=m[e.attr("data-rating")];return parseInt(a)-parseInt(r)}function i(t,e){var a=t.attr("data-read"),r=e.attr("data-read");return parseInt(a)-parseInt(r)}function o(t,e){var a=t.attr("data-total"),r=e.attr("data-total");return parseInt(a)-parseInt(r)}function l(t,e){var a=t.attr("data-date"),r=e.attr("data-date");return parseInt(a)-parseInt(r)}function d(){for(var t=0;t<b.length;t++){var e=b[t],a=e.attr("data-title").toLowerCase(),r=e.attr("data-rating"),c=""===k.title||a.includes(k.title),n=3===k.rating.length||-1!==k.rating.indexOf(r);c&&n?e.show():e.hide()}p()}function p(){for(var t=0,e=0;e<b.length;e++)b[e].is(":visible")&&t++;h.text("Showing "+t+" of "+b.length+" comics.")}var m={PG:1,R:2,"NC-17":3},b=[],g=null,u=t(a.createElement("div")),h=t(a.createElement("div")).attr("id","comic-status-text"),f=0,v=0,k={title:"",rating:["PG","R","NC-17"]};t(a).ready(function(){var e=["#comic-rocket-science-controls {background-color: #51493d; color: #FFF; margin: 0 auto 20px; width: 552px; padding: 10px;}","#comic-rocket-science-controls .comics-item-image span {height: auto; padding: 0 0 1ex 0;}","#comic-rocket-science-controls .form-search input {border-radius: 3px; padding-left: 10px; width: calc(100% - 14px);}","#comic-rocket-science-controls label {color: #FFF; display: inline-block;}","#comic-rocket-science-controls label + label {margin-left: 5px;}","#comic-rocket-science-controls label input {display: inline;}","#comic-rocket-science-controls .btn-primary {padding: 5px 10px; background-image: none;}","#comic-rocket-science-controls .btn-primary span {display: none;}","#comic-rocket-science-controls .btn-primary.sorted-asc {font-weight: bold;}","#comic-rocket-science-controls .btn-primary.sorted-desc {font-weight: bold;}","#comic-rocket-science-controls .btn-primary.sorted-asc .asc {display: inline;}","#comic-rocket-science-controls .btn-primary.sorted-desc .desc {display: inline;}","#comic-rocket-science-controls .btn-primary + .btn-primary {margin-left: 5px;}","#comic-status-text {margin: 0 auto 10px; width: 572px;}"],r="<style>"+e.join("")+"</style>";t("head").append(r),t(".comics-item").each(function(){var e=t(this),a=e.find(".comics-item-image span").text(),r=e.find(".comics-item-rating abbr").text(),c=e.find(".comics-item-date div").text().replace("Updated: ","").replace("-",""),n=e.find(".progress-label").text().split("/");f+=parseInt(n[0]),v+=parseInt(n[1]),e.attr("data-title",a),e.attr("data-rating",r),e.attr("data-date",c),e.attr("data-read",n[0]),e.attr("data-total",n[1]),null===g&&(g=e.parent()),b.push(e)}),g.attr("id","comics-wrapper");var s=t("#comic-rocket-sidebar").parent().children()[0],i=t(s).children()[0],o=f/v*100;t(i).append("<p>Overall progress: "+f+"/"+v+" ("+o.toFixed(2)+"%)</p>");var l=t(a.createElement("div"));l.attr("id","comic-rocket-science-controls");var d='<span class="comics-item-image"><span>Comic Rocket <strong>Science</strong></span></span>',p='<div class="form-search"><input id="crs-title-search" placeholder="Filter by title"/></div>',m=['<label><input type="checkbox" name="crs-rating-filter" value="PG" checked> PG</label>','<label><input type="checkbox" name="crs-rating-filter" value="R" checked> R</label>','<label><input type="checkbox" name="crs-rating-filter" value="NC-17" checked> NC-17</label>'],k='<span class="asc"> &uparrow;</span><span class="desc"> &downarrow;</span>',y=['<a class="btn btn-primary sort-btn sorted-asc" id="crs-sort-title" href="#">Title'+k+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-rating" href="#">Rating'+k+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-read" href="#">Read'+k+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-total" href="#">Total'+k+"</a>",'<a class="btn btn-primary sort-btn" id="crs-sort-updated" href="#">Updated'+k+"</a>"],x=[d,p,"<strong>Filter by rating:</strong>",m.join(""),"<strong>Sort by:</strong>",y.join("")];g.empty().prepend(l).append(u),l.append(x.join("<br>")),l.after("<hr>"),u.before(h),b.sort(n),c()}),t(".span8").on("keyup","#crs-title-search",function(e){e.preventDefault(),e.stopPropagation(),k.title=t(this).val().toLowerCase(),d()}),t(".span8").on("click","#comic-rocket-science-controls .sort-btn",function(e){e.preventDefault(),e.stopPropagation();var a=t(this),r=1;a.hasClass("sorted-asc")?r=-1:a.hasClass("sorted-desc")&&(r=1),t("#comic-rocket-science-controls .sort-btn").removeClass("sorted-asc").removeClass("sorted-desc");var d=a.attr("id").replace("crs-sort-","");switch(d){case"title":b.sort(n);break;case"rating":b.sort(s);break;case"read":b.sort(i);break;case"total":b.sort(o);break;case"updated":b.sort(l)}0>r?(b.reverse(),a.addClass("sorted-desc")):a.addClass("sorted-asc"),c()}),t(".span8").on("click","#comic-rocket-science-controls input",function(e){e.stopPropagation();var a=t(this);if(a.attr("checked"))k.rating.push(a.val());else{var r=k.rating.indexOf(a.val());k.rating.splice(r,1)}d()})}(window.jQuery,window,document);